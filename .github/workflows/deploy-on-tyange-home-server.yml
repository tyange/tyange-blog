name: deploy tyange-blog on tyange home server
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: tyange-home-server
    steps:
      - name: Deploy to home server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/tyange/dev/deploy/tyange-blog

            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/tyange/tyange-blog.git
            fi

            git fetch origin
            git reset --hard origin/master
            pnpm install --frozen-lockfile
            pnpm run build

            mkdir -p logs

            pm2 restart ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

            pm2 list
            pm2 logs tyange-blog --lines 5
          envs: |
            NITRO_PORT=${{ vars.PORT }}
            NODE_ENV=production
            NUXT_PUBLIC_TYANGE_CMS_API_BASE=${{ vars.NUXT_PUBLIC_TYANGE_CMS_API_BASE }}
